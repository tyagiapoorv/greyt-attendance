name: Daily Attendance
on:
  schedule:
    - cron: '30 3 * * *'
  workflow_dispatch:

jobs:
  mark-attendance:
    runs-on: ubuntu-latest
    steps:
      - name: Random Delay (0-30 mins)
        run: |
          DELAY=$((RANDOM % 1801))
          echo "Sleeping for $DELAY seconds (~$((DELAY / 60)) minutes)..."
          sleep $DELAY
          
      - name: Mark Attendance
        env:
          COOKIE: ${{ secrets.ATTENDANCE_COOKIE }}
        run: |
          set -euo pipefail
          
          ENDPOINT="https://paypay-india.greythr.com/v3/api/attendance/mark-attendance?action=Signin"
          
          # Capture both response body and HTTP status code
          response=$(curl -s -w "\n%{http_code}" --request POST \
            --url "$ENDPOINT" \
            --header "accept: application/json" \
            --header "accept-language: en-GB,en-US;q=0.9,en;q=0.8" \
            --header "content-type: application/json" \
            --header "cookie: $COOKIE" \
            --header "origin: https://paypay-india.greythr.com" \
            --header "priority: u=1, i" \
            --header "referer: https://paypay-india.greythr.com/v3/portal/ess/home" \
            --header 'sec-ch-ua: "Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"' \
            --header "sec-ch-ua-mobile: ?0" \
            --header 'sec-ch-ua-platform: "macOS"' \
            --header "sec-fetch-dest: empty" \
            --header "sec-fetch-mode: cors" \
            --header "sec-fetch-site: same-origin" \
            --header "user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36" \
            --header "x-requested-with: XMLHttpRequest" \
            --data '{}')
          
          # Extract status code and body
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          # Check if request was successful
          if [ "$http_code" -eq 401 ] || [ "$http_code" -eq 403 ]; then
            echo "::error::üî¥ Session expired! Cookie needs refresh. HTTP $http_code"
            echo "::error::Please login to GreytHR, get new cookie, and update ATTENDANCE_COOKIE secret"
            exit 1
          elif [ "$http_code" -ne 200 ] && [ "$http_code" -ne 201 ]; then
            echo "::warning::‚ö†Ô∏è Unexpected status code: $http_code"
            exit 1
          fi
          
          echo "‚úÖ Attendance marked successfully!"
